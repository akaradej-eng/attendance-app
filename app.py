import streamlit as st
import pandas as pd
import gspread
import json
from datetime import datetime

# 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
creds_dict = json.loads(st.secrets["google_sheet"]["credentials"])
gc = gspread.service_account_from_dict(creds_dict)
sh = gc.open("‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")
ws_students = sh.worksheet("Students")
ws_attendance = sh.worksheet("Attendance")

st.set_page_config(page_title="Dschool AI - One Line", layout="wide", page_icon="üè´")

# üé® CSS ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÅ‡∏≠‡∏õ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
st.markdown("""
    <style>
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Container ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô */
    .student-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: white;
        padding: 8px 15px;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        margin-bottom: 5px;
    }
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
    .student-info {
        flex: 1;
        font-size: 16px;
        color: #333;
    }
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Selectbox ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏≠‡∏î‡∏µ */
    div[data-baseweb="select"] {
        width: 130px !important;
    }
    .stSelectbox label { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô Label ‡∏Ç‡∏≠‡∏á Selectbox */
    
    /* ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î Dashboard */
    .summary-box {
        background-color: #1e56a0;
        color: white;
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
    }
    </style>
    """, unsafe_allow_html=True)

st.markdown("<h2 style='text-align: center; color: #1e56a0;'>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>", unsafe_allow_html=True)

data = ws_students.get_all_records()

if len(data) > 0:
    df_students = pd.DataFrame(data)
    class_list = sorted(df_students['‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'].unique().tolist())

    # ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π
    with st.container(border=True):
        c1, c2 = st.columns(2)
        with c1: selected_class = st.selectbox("üìÖ ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", class_list)
        with c2: check_date = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.today())
        
        room_info = df_students[df_students['‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] == selected_class].iloc[0]
        teachers = [t for t in [room_info.get('‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ 1'), room_info.get('‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ 2'), room_info.get('‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ 3')] if t]
        recorded_by = st.radio("üë§ ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:", teachers, horizontal=True)

    df_room = df_students[df_students['‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] == selected_class].copy()
    date_str = check_date.strftime("%d/%m/%Y")

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥
    all_attendance = ws_attendance.get_all_records()
    df_att_check = pd.DataFrame(all_attendance)
    is_already_checked = False
    if not df_att_check.empty:
        if not df_att_check[(df_att_check['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] == date_str) & (df_att_check['‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] == selected_class)].empty:
            is_already_checked = True

    if is_already_checked:
        st.error(f"‚ö†Ô∏è ‡∏´‡πâ‡∏≠‡∏á {selected_class} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {date_str} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")
    else:
        # ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î Dashboard
        if 'att_data' not in st.session_state:
            st.session_state.att_data = {str(r['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']): "‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" for _, r in df_room.iterrows()}
        
        stats = pd.Series(st.session_state.att_data.values()).value_counts()
        st.markdown(f"""
            <div class='summary-box'>
                <b>‡∏°‡∏≤: {stats.get('‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 0)} | ‡∏™‡∏≤‡∏¢: {stats.get('‡∏™‡∏≤‡∏¢', 0)} | ‡∏•‡∏≤: {stats.get('‡∏•‡∏≤', 0) + stats.get('‡∏õ‡πà‡∏ß‡∏¢', 0)} | ‡∏Ç‡∏≤‡∏î: {stats.get('‡∏Ç‡∏≤‡∏î', 0)}</b>
            </div>
        """, unsafe_allow_html=True)

        # üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (One-Line)
        status_options = ["‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏™‡∏≤‡∏¢", "‡∏•‡∏≤", "‡∏õ‡πà‡∏ß‡∏¢", "‡∏Ç‡∏≤‡∏î"]
        
        for index, row in df_room.iterrows():
            sid = str(row['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'])
            
            # ‡πÉ‡∏ä‡πâ st.columns ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞‡πÜ
            col_name, col_status = st.columns([7, 3])
            
            with col_name:
                # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                st.markdown(f"<div style='padding-top:10px;'>{index+1}. {row.get('‡∏ä‡∏∑‡πà‡∏≠','')}</div>", unsafe_allow_html=True)
            
            with col_status:
                current_val = st.session_state.att_data.get(sid, "‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")
                new_status = st.selectbox(
                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", status_options, key=f"sel_{sid}", 
                    label_visibility="collapsed",
                    index=status_options.index(current_val)
                )
                if new_status != current_val:
                    st.session_state.att_data[sid] = new_status
                    st.rerun()
            
            st.markdown("<hr style='margin: 2px 0; border-top: 1px solid #eee;'>", unsafe_allow_html=True)

        if st.button("üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", type="primary", use_container_width=True):
            try:
                final_records = [[date_str, str(r['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']), r.get('‡∏ä‡∏∑‡πà‡∏≠',''), 
                                 r.get('‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',''), st.session_state.att_data[str(r['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'])], 
                                 recorded_by] for _, r in df_room.iterrows()]
                ws_attendance.append_rows(final_records)
                st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                st.balloons()
                st.rerun()
            except Exception as e:
                st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
